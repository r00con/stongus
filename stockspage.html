<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stongus â€“ Stock</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Press Start 2P', cursive;
  background: #0b0b0b;
  color: white;
}

#topbar {
  display: flex;
  justify-content: space-between;
  padding: 12px;
  background: #111;
  border-bottom: 3px solid #222;
}

button {
  font-family: 'Press Start 2P', cursive;
  padding: 8px 12px;
  margin: 4px;
  border: none;
  cursor: pointer;
}

.buy { background: #2ecc71; }
.sell { background: #e74c3c; }
.back { background: #555; }

#content {
  padding: 30px;
  text-align: center;
}

.box {
  border: 3px solid #333;
  padding: 30px;
  background: #151515;
  display: inline-block;
  min-width: 320px;
}
</style>
</head>

<body>

<div id="topbar">
  <div id="user">Loading...</div>
  <button class="back" onclick="goBack()">Back</button>
</div>

<div id="content">
  <div class="box">
    <h2 id="stockName">Loading...</h2>
    <p id="price">Price: --</p>
    <p id="owned">You own: 0</p>

    <div>
      <button class="buy" onclick="buy()">Buy 1</button>
      <button class="sell" onclick="sell()">Sell 1</button>
    </div>
  </div>
</div>

<script>
/* =====================
   SAFE BOOTSTRAP
   ===================== */
const user = localStorage.getItem("stongus_user");
const stock = localStorage.getItem("stongus_selected_stock");

if (!user || !stock) {
  location.href = "gamepage.html";
}

document.getElementById("user").innerText = user;

let stockPrice = 0;

/* =====================
   LOAD DATA
   ===================== */
async function load() {
  try {
    const stocksRes = await fetch("/stocks");
    const playerRes = await fetch(`/player?user=${user}`);

    const stocks = await stocksRes.json();
    const player = await playerRes.json();

    if (!stocks || !stocks[stock] || !player) {
      console.error("Missing data");
      return;
    }

    stockPrice = stocks[stock];
    const qty = player.stocks[stock] || 0;

    document.getElementById("stockName").innerText = stock;
    document.getElementById("price").innerText = "Price: $" + stockPrice;
    document.getElementById("owned").innerText = "You own: " + qty;

  } catch (err) {
    console.error("Failed to load stock page", err);
  }
}

/* =====================
   ACTIONS
   ===================== */
async function buy() {
  await fetch("/buy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user, stock })
  });
  load();
}

async function sell() {
  await fetch("/sell", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user, stock })
  });
  load();
}

/* =====================
   NAVIGATION
   ===================== */
function goBack() {
  location.href = "gamepage.html";
}

/* =====================
   START
   ===================== */
load();
</script>

</body>
</html>
